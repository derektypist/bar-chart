<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D3 Bar Chart</title>
    <!-- Load Styles -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet" />
    <style>
    /* Universal Styles */

    html {
        height: 100%;
    }

    body {
        font-family: "Roboto", Arial, Verdana, sans-serif;
        background-color: seagreen;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100%;
    }

    svg {
        background-color: lightblue;
        box-shadow: 0px 3px 5px rgba(0, 0, 0, 0.2);
        border-radius: 5px;
        padding: 10px;
    }

   /* Title */
   #title {
       font-size: 30px;
       fill: purple;
   }

    /* Chart */
    .bar {
        background-color: green;
        border-color: green;
        fill: green;
    }

    bar:hover {
        fill: blue;
    }

    g {
        color: blue;
    }

    #tooltip {
        margin-top: 10px;
        color: lightblue;
        font-size: 28px;
    }

    </style>
    <!-- Load Script -->
    <script src="https://d3js.org/d3.v6.min.js"></script>
</head>
<body>
    <!-- Set Up SVG -->
    <svg id='canvas'>
        <text id='title' x='100' y='30'>USA GDP</text>
    </svg>
    <!-- Load Script -->
    
    <script defer>
    // Initialise Variables
    let url = 'https://raw.githubusercontent.com/freeCodeCamp/ProjectReferenceData/master/GDP-data.json';
    let req = new XMLHttpRequest();
    let data;
    let values = [];
    let heightScale;
    let xScale;
    let xAxisScale;
    let yAxisScale;
    let width = 800;
    let height = 600;
    let padding = 40;
    let svg = d3.select('svg');

    // Draw Canvas
    let drawCanvas = () => {
        svg.attr('width', width);
        svg.attr('height', height);
    };

    // Set Up Scales
    let generateScales = () => {
        heightScale = d3.scaleLinear()
                        .domain([0, d3.max(values, (item) => {
                            return item[1];
                        })])
                        .range([0, height - (2 * padding)]);

        xScale = d3.scaleLinear()
                    .domain([0, values.length-1])
                    .range([padding, width - padding]);

        let datesArray = values.map((item) => {
            return new Date(item[0]);
        });

        xAxisScale = d3.scaleTime()
                    .domain([d3.min(datesArray), d3.max(datesArray)])
                    .range([padding, width-padding]);

        yAxisScale = d3.scaleLinear()
                    .domain([0, d3.max(values, (item) => {
                        return item[1];
                    })])
                    .range([height-padding, padding]);
    };

    // Draw Bars
    let drawBars = () => {
        let tooltip = d3.select('body')
                    .append('div')
                    .attr('id', 'tooltip')
                    .style('visibility', 'hidden')
                    .style('width', 'auto')
                    .style('height', 'auto');
    };

    
    // Set Up Tooltip
    let tooltip = d3
        .select('.visHolder')
        .append('div')
        .attr('id', 'tooltip')
        .style('opacity', 0);

    // Set Up Overlay
    let overlay = d3
        .select('.visHolder')
        .append('div')
        .attr('class', 'overlay')
        .style('opacity', 0);

    // Set Up SVG Container
    let svgContainer = d3
        .select('.visHolder')
        .append('svg')
        .attr('width', width + 100)
        .attr('height', height + 60);

   
    
    svgContainer
      .append('text')
      .attr('transform', 'rotate(-90)')
      .attr('x', -200)
      .attr('y', 80)
      .text('Gross Domestic Product');

    svgContainer
      .append('text')
      .attr('x', width / 2 + 120)
      .attr('y', height + 50)
      .text('More Information: http://www.bea.gov/national/pdf/nipaguid.pdf')
      .attr('class', 'info');

    let years = data.data.map(function (item) {
      let quarter;
      let temp = item[0].substring(5, 7);

    // Determine what quarter should be
      if (temp === '01') {
        quarter = 'Q1';
      } else if (temp === '04') {
        quarter = 'Q2';
      } else if (temp === '07') {
        quarter = 'Q3';
      } else if (temp === '10') {
        quarter = 'Q4';
      }

      return item[0].substring(0, 4) + ' ' + quarter;
    });

    let yearsDate = data.data.map(function (item) {
      return new Date(item[0]);
    });

    // Set Up Axes
    let xMax = new Date(d3.max(yearsDate));
    xMax.setMonth(xMax.getMonth() + 3);
    let xScale = d3
      .scaleTime()
      .domain([d3.min(yearsDate), xMax])
      .range([0, width]);

    let xAxis = d3.axisBottom().scale(xScale);

    svgContainer
      .append('g')
      .call(xAxis)
      .attr('id', 'x-axis')
      .attr('transform', 'translate(60, 400)');

    let GDP = data.data.map(function (item) {
      return item[1];
    });

    let scaledGDP = [];

    let gdpMax = d3.max(GDP);

    let linearScale = d3.scaleLinear().domain([0, gdpMax]).range([0, height]);

    scaledGDP = GDP.map(function (item) {
      return linearScale(item);
    });

    let yAxisScale = d3.scaleLinear().domain([0, gdpMax]).range([height, 0]);

    let yAxis = d3.axisLeft(yAxisScale);

    svgContainer
      .append('g')
      .call(yAxis)
      .attr('id', 'y-axis')
      .attr('transform', 'translate(60, 0)');

    // Plot Bar Chart
    d3.select('svg')
      .selectAll('rect')
      .data(scaledGDP)
      .enter()
      .append('rect')
      .attr('data-date', function (d, i) {
        return data.data[i][0];
      })
      .attr('data-gdp', function (d, i) {
        return data.data[i][1];
      })
      .attr('class', 'bar')
      .attr('x', function (d, i) {
        return xScale(yearsDate[i]);
      })
      .attr('y', function (d) {
        return height - d;
      })
      .attr('width', barWidth)
      .attr('height', function (d) {
        return d;
      })
      .style('fill', 'green')
      .attr('transform', 'translate(60, 0)')
      .on('mouseover', function (d, i) {
        overlay
          .transition()
          .duration(0)
          .style('height', d + 'px')
          .style('width', barWidth + 'px')
          .style('opacity', 0.9)
          .style('left', i * barWidth + 0 + 'px')
          .style('top', height - d + 'px')
          .style('transform', 'translateX(60px)');
        tooltip.transition().duration(200).style('opacity', 0.9);
        tooltip
          .html(
            years[i] +
              '<br>' +
              '$' +
              GDP[i].toFixed(1).replace(/(\d)(?=(\d{3})+\.)/g, '$1,') +
              ' Billion'
          )
          .attr('data-date', data.data[i][0])
          .style('left', i * barWidth + 30 + 'px')
          .style('top', height - 100 + 'px')
          .style('transform', 'translateX(60px)');
      })
      .on('mouseout', function () {
        tooltip.transition().duration(200).style('opacity', 0);
        overlay.transition().duration(200).style('opacity', 0);
      });
  
  req.open('GET', url, true);
  req.onload = () => {
      data = JSON.parse(req.responseText);
      values = data.data;
      console.log(values);
      drawCanvas();
      generateScales();
  };
  req.send();
    </script>
</body>
</html>